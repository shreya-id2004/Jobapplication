<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Application</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="/style.css" />
</head>

<body>
    <%- include('partials/navebar') %>

    <div class="page-header">
            <h1>Job Application Tracker</h1>
            <p class="subtitle">Track all your job applications in one place</p>
        </div>

        <!-- Alert message -->
    <% if (messages && messages.success) { %>
            <div class="alert alert-success" id="flashMessage">
                <span class="alert-icon">✓</span>
                <%= messages.success %>
            </div>
        <% } %>

        <% if (messages && messages.error) { %>
            <div class="alert alert-error" id="flashMessage">
                <span class="alert-icon">✕</span>
                <%= messages.error %>
            </div>
        <% } %>

                    <!-- <div class="auth-buttons">
                        <button class="btn"><a href="/user/login">Log in</a></button>
                        <button class="btn"><a href="/user/signup">Sign up</a></button>
                        <button class="btn"><a href="/user/logout">Log out</a></button>
                    </div> -->

                    <div class="search filter-controls">
                        <input type="text" id="searchBox" placeholder="Search Jobs..." onkeyup="searchJobs()">
                        <select id="statusFilter" onchange="filterJobs()">
                            <option value="all">All</option>
                            <option value="pending">Pending</option>
                            <option value="interview">Interview</option>
                            <option value="declined">Declined</option>
                        </select>

                        <button class="btn btn-primary" onclick="location.href='/add'">
                    ➕ Add New Job
                </button>

                    </div>

                    <!-- Stats Overview -->
        <% 
            let pendingCount = jobs.filter(j => j.status === 'pending').length;
            let interviewCount = jobs.filter(j => j.status === 'interview').length;
            let declinedCount = jobs.filter(j => j.status === 'declined').length;
        %>
        <div class="stats-overview">
            <div class="stat-box pending">
                <div class="stat-number"><%= pendingCount %></div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-box interview">
                <div class="stat-number"><%= interviewCount %></div>
                <div class="stat-label">Interview</div>
            </div>
            <div class="stat-box declined">
                <div class="stat-number"><%= declinedCount %></div>
                <div class="stat-label">Declined</div>
            </div>
            <div class="stat-box total">
                <div class="stat-number"><%= jobs.length %></div>
                <div class="stat-label">Total</div>
            </div>
        </div>

                    <div class="table">
                        <table>
                            <tr>
                                <th>Company</th>
                                <th>Position</th>
                                <th>Applied</th>
                                <th>Days Left</th>
                                <th>Status</th>
                                <th>Link</th>
                                <th>Actions</th>
                                <th>Notes</th>
                            </tr>

                            <% jobs.forEach((job,index)=> { %>
                                <tr id="job-<%=job._id %>">


                                    <td>
                                        <span class="job-text">
                                            <%=job.company%>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="job-text">
                                            <%= job.position %>
                                        </span>
                                    </td>
                                    <td>
                                        <span id="time-<%= job._id %>">
                                            <%= new Date(job.createdAt).toLocaleDateString('en-US', { month: 'short' ,
                                                day: 'numeric' , year: 'numeric' }) %>
                                        </span>
                                    </td>

                                    <!-- Days Left Until Deadline -->
                        <td>
                            <% 
                                let deadlineDate = job.deadline ? new Date(job.deadline) : null;
                                let today = new Date();
                                let timeDiff = deadlineDate - today;
                                let daysLeft = deadlineDate ? Math.ceil(timeDiff / (1000 * 60 * 60 * 24)) : null;
                            %>
                            <span id="days-<%= job._id %>">
                                <% if (deadlineDate) { %>
                                    <% if (daysLeft > 0) { %>
                                        <%= daysLeft %> days left
                                    <% } else { %>
                                        Deadline passed
                                    <% } %>
                                <% } else { %>
                                    No deadline
                                <% } %>
                            </span>
                        </td>
                                    <td>
                                        <select onchange="updateStatus(this, '<%= job._id %>')" class="status-select">
                                            <option value="pending" <%=job.status==='pending' ? 'selected' : '' %>>
                                                Pending
                                            </option>
                                            <option value="interview" <%=job.status==='interview' ? 'selected' : '' %>>
                                                Interview
                                            </option>
                                            <option value="declined" <%=job.status==='declined' ? 'selected' : '' %>>
                                                Declined
                                            </option>
                                        </select>
                                    </td>

                                    <td>
                                        <% if (job.link) { %>
                                            <button class="btn">
                                                <a href="<%= job.link %>" target="_blank">Link</a>
                                            </button>
                                            <% } else { %>
                                                <span>No link</span>
                                                <% } %>
                                    </td>

                                    <td>
                                        <button class="btn"><a href="/edit/<%=job._id %>">Edit</a></button>
                                        <button class="btn"><a href="/delete/<%= job._id %>">Delete</a></button>
                                    </td>

                                    <td>
                                        <textarea id="notes-<%= job._id %>" class="notes-input"
                                            placeholder="Add notes..." onblur="updateNotes('<%= job._id %>')">
                        <%= job.notes %></textarea>
                                    </td>

                                </tr>
                                <% }); %>

                        </table>
                        <button class="btn " id="btn1"><a href="/add">Add Job</a></button>
                    </div>
                    <script src="/script.js"></script>
                    <script>
        // Auto-hide alert messages after 5 seconds
        const alert = document.getElementById('flashMessage');
        if (alert) {
            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transition = 'opacity 0.5s ease';
                setTimeout(() => alert.remove(), 500);
            }, 5000);
        }
    </script>
</body>

</html>