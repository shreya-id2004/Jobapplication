<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Application</title>
    <link rel="stylesheet" href="/style.css" />
</head>

<body>
    <h1>Job Application</h1>

    <% if (messages.success) { %>
        <div class="alert success" id="flashMessage">
            <%= messages.success %>
        </div>
        <% } %>

            <% if (messages.error) { %>
                <div class="alert error" id="flashMessage">
                    <%= messages.error %>
                </div>
                <% } %>

                    <div class="auth-buttons">
                        <button class="btn"><a href="/user/login">Log in</a></button>
                        <button class="btn"><a href="/user/signup">Sign up</a></button>
                        <button class="btn"><a href="/user/logout">Log out</a></button>
                    </div>

                    <div class="search">
                        <input type="text" id="searchBox" placeholder="Search Jobs..." onkeyup="searchJobs()">
                        <select id="statusFilter" onchange="filterJobs()">
                            <option value="all">All</option>
                            <option value="pending">Pending</option>
                            <option value="interview">Interview</option>
                            <option value="declined">Declined</option>
                        </select>
                    </div>

                    <div class="table">
                        <table>
                            <tr>
                                <th>Company</th>
                                <th>Position</th>
                                <th>Applied</th>
                                <th>Days Left</th>
                                <th>Status</th>
                                <th>Link</th>
                                <th>Actions</th>
                                <th>Notes</th>
                            </tr>

                            <% jobs.forEach((job,index)=> { %>
                                <tr id="job-<%=job._id %>">


                                    <td>
                                        <span class="job-text">
                                            <%=job.company%>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="job-text">
                                            <%= job.position %>
                                        </span>
                                    </td>
                                    <td>
                                        <span id="time-<%= job._id %>">
                                            <%= new Date(job.createdAt).toLocaleDateString('en-US', { month: 'short' ,
                                                day: 'numeric' , year: 'numeric' }) %>
                                        </span>
                                    </td>

                                    <!-- Days Left Until Deadline -->
                        <td>
                            <% 
                                let deadlineDate = job.deadline ? new Date(job.deadline) : null;
                                let today = new Date();
                                let timeDiff = deadlineDate - today;
                                let daysLeft = deadlineDate ? Math.ceil(timeDiff / (1000 * 60 * 60 * 24)) : null;
                            %>
                            <span id="days-<%= job._id %>">
                                <% if (deadlineDate) { %>
                                    <% if (daysLeft > 0) { %>
                                        <%= daysLeft %> days left
                                    <% } else { %>
                                        Deadline passed
                                    <% } %>
                                <% } else { %>
                                    No deadline
                                <% } %>
                            </span>
                        </td>
                                    <td>
                                        <select onchange="updateStatus(this, '<%= job._id %>')" class="status-select">
                                            <option value="pending" <%=job.status==='pending' ? 'selected' : '' %>>
                                                Pending
                                            </option>
                                            <option value="interview" <%=job.status==='interview' ? 'selected' : '' %>>
                                                Interview
                                            </option>
                                            <option value="declined" <%=job.status==='declined' ? 'selected' : '' %>>
                                                Declined
                                            </option>
                                        </select>
                                    </td>

                                    <td>
                                        <% if (job.link) { %>
                                            <button class="btn">
                                                <a href="<%= job.link %>" target="_blank">Link</a>
                                            </button>
                                            <% } else { %>
                                                <span>No link</span>
                                                <% } %>
                                    </td>

                                    <td>
                                        <button class="btn"><a href="/edit/<%=job._id %>">Edit</a></button>
                                        <button class="btn"><a href="/delete/<%= job._id %>">Delete</a></button>
                                    </td>

                                    <td>
                                        <textarea id="notes-<%= job._id %>" class="notes-input"
                                            placeholder="Add notes..." onblur="updateNotes('<%= job._id %>')">
                        <%= job.notes %></textarea>
                                    </td>

                                </tr>
                                <% }); %>

                        </table>
                        <button class="btn " id="btn1"><a href="/add">Add Job</a></button>
                    </div>
                    <script src="/script.js"></script>
</body>

</html>